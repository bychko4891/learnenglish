<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head th:replace="~{fragments/head :: head}"></head>
<body>
<div id="toastContainer" class="toast-container"></div>
<div class="wrapper">
    <main class="section">
        <header th:replace="~{fragments/header :: header}"></header>
        <div class="container layout_page row">
            <div class="col-md-11 forgot-password-page">
                <h3>Відновити пароль</h3><br>
                <p>Для відновлення пароля впишіть в поле будь ласка свій email та потім використовуйте вказівки в
                    єлектронному листі,</p>
                <p>який надійде на пошту, на яку був зареєстрований аккаунт в додатку.</p>
                <div class="forgot-password-page-form">
                    <form id="forgotPassword" th:action="@{/forgot-password}" method="post"
                          style="align-items: center; flex-direction: column;">
                        <input type="email" name="email" style="width: 390px; margin-bottom: 20px;"
                               placeholder="user@email.com">
                        <!--                        <div class="row">-->
                        <div style="display: flex">
                            <div style="display: flex; width: 115px;">
                                <div id="randomNumbers1" class="captcha"></div>
                                <div class="captcha">+</div>
                                <div id="randomNumbers2" class="captcha"></div>
                            </div>
                            <div class="col-sm-2" style="margin-bottom: 15px;">
                                <button id="reloadCaptcha" type="button" class="btn btn-info" onclick="reloadCaptcha()">
                                    <span class="captcha_ico"></span>
                                </button>
                            </div>
                            <div class="col-sm-4" style="padding-top: 5px;">
                                <input type="text" id="captcha" name="captcha" placeholder="Сумма двох чисел">
                            </div>
                        </div>
                        <div style="padding-left: 115px; margin-bottom: 15px;">
                            <button type="submit">Відновити</button>
                        </div>
                    </form>
                </div>
                <br>
                <div id="resultDivError" style="color: red"></div>
                <div id="resultDivSuccess" style="color: #0f5132"></div>
            </div>
        </div>
    </main>
    <div th:replace="~{fragments/menu :: menu}"></div>
</div>
<script>
    // Функція для генерації випадкових чисел та відправки суми на сервер
    function generateAndSend() {
        // Генерування випадкових чисел
        var number1 = Math.floor(Math.random() * 100) + 1; // Від 1 до 100
        var number2 = Math.floor(Math.random() * 9) + 1; // Від 1 до 9

        // Обчислення суми
        var sum = number1 + number2;

        // Оновлення вмісту div з числами
        var randomNumbersDiv1 = document.getElementById('randomNumbers1');
        randomNumbersDiv1.innerHTML = number1;
        var randomNumbersDiv2 = document.getElementById('randomNumbers2');
        randomNumbersDiv2.innerHTML = number2;

        // Відправка суми на сервер
        var xhr = new XMLHttpRequest();
        var url = '/forgot-password/captcha'; // Замініть на власну адресу контроллера

        xhr.open('POST', url, true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

        // Додавання CSRF-токену до заголовків
        var csrfToken = $("meta[name='_csrf']").attr("content");
        var csrfHeader = $("meta[name='_csrf_header']").attr("content");
        xhr.setRequestHeader(csrfHeader, csrfToken);

        xhr.onreadystatechange = function () {
            if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
                // Операція успішно виконана
                console.log('Сума була успішно відправлена на сервер.');
            }
        };

        var data = 'sum=' + encodeURIComponent(sum);
        xhr.send(data);
    }

    // Додавання обробника події на кнопку "Згенерувати та відправити"
    var generateButton = document.getElementById('reloadCaptcha');
    generateButton.addEventListener('click', generateAndSend);

    // Запуск генерації та відправки при завантаженні сторінки
    window.addEventListener('load', generateAndSend);

    $(document).ready(function () {
        var resultDivSuccess = $('#resultDivSuccess');
        var resultDivError = $('#resultDivError');
        $('#forgotPassword').submit(function (event) {
            event.preventDefault();
            var url = $(this).attr('action');
            var formData = $(this).serializeArray();
            $.ajax({
                url: url,
                type: "POST",
                data: formData,
                success: function (result) {
                    var status = result.status;
                    // console.log(status);
                    if (status == "Success") {
                        $('input[name="password"]').val('');
                        $('input[name="newPassword"]').val('');
                        // Отримуємо div-елемент, в який ми будемо поміщати повідомлення
                        resultDivSuccess.text(result.message);
                        setTimeout(hideMessageSuccess, 5000);
                        setTimeout(function () {
                            window.location.href = "/login";
                        }, 3000);
                    } else {
                        resultDivError.text(result.message);
                        setTimeout(hideMessageError, 5000);
                    }
                },
                error: function () {
                    let shel = {};
                    alert(Boolean(shel))
                    resultDivError.text('Помилка запиту на сервер');
                    setTimeout(hideMessageError, 5000);
                }
            });
            // } else {
            //     // якщо не всі поля не заповнені, не виконуємо запит на сервер і виводимо помилку
            //     alert('Будь ласка, заповніть поле вводу');
            //     return;
            // }
            // } else {
            //     console.log("console info: Інформація успішно оновлена");
            //     resultDivSuccess.text("Інформація успішно оновлена");
            //     setTimeout(hideMessageSuccess, 5000);
            // }
        });

        function hideMessageSuccess() {
            resultDivSuccess.text('');
        }

        function hideMessageError() {
            resultDivError.text('');
        }
    });
</script>
</body>
</html>