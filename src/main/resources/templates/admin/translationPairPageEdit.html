<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head th:replace="~{fragments/head :: head}"></head>
<script src="https://cdn.tiny.cloud/1/j8dxs8puyiugoamq11vn3bctaonh1jhzvd0cewcb1jiyl2c6/tinymce/5/tinymce.min.js"
        referrerpolicy="origin"></script>
<!--<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">-->
<style>
    .search_result_style {
        position: absolute;
        top: 60px;
        background: white;
        color: black;
        height: auto;
        width: 500px;
        border-radius: 20px;
        padding: 10px;
        z-index: 9999;
    }
    .result-block {
        display: flex;
    }
</style>
<body class="active">
<div id="toastContainer" class="toast-container"></div>
<div class="wrapper">
    <main class="section">
        <header th:replace="~{fragments/header :: header}"></header>
        <div class="container layout_page">

            <h1>Нова сторінка для фраз</h1>
            <form id="phrasesPage">
                <label for="name">Назва:</label>
                <input type="text" id="name" name="name" th:value="${translationPairsPage.name}">
                <label>Категорія:</label> <label th:text="${category} + ' | '"></label>
                <label for="mainCategorySelect">Змінити категорію: </label>
                <select id="mainCategorySelect" name="selectedPageApplication">
                    <option name="id" value="0">Оберіть категорію</option>
                    <option th:each="mainTranslationPairsPagesCategory : ${mainTranslationPairsPagesCategories}"
                            th:value="${mainTranslationPairsPagesCategory.id}"
                            th:text="${mainTranslationPairsPagesCategory.name}">
                    </option>
                </select>
                <select id="subcategorySelect" name="subcategorySelect">
                    <option name="id" value="0">Оберіть підкатегорію</option>
                </select>
                <select id="subSubcategorySelect" name="subcategorySelect">
                    <option name="id" value="0">Оберіть підкатегорію</option>
                </select>
                <span style="padding: 10px 0px 0px 25px;">Опубліковано: </span>
                <input id="toggleSwitch" type="checkbox" th:checked="${translationPairsPage.published}"
                       class="toggle-switch" name="published">
                <label for="toggleSwitch" class="toggle-switch-label"></label>

                <div id="addedItemsContainer" ></div>
                <hr>
                <label for="phrasesPageInfo">Текст:</label>
                <textarea id="phrasesPageInfo" name="info" th:text="${translationPairsPage.info}"></textarea>
                <input type="hidden" name="id" th:value="${translationPairsPage.id}" required>
                <button type="submit">Зберегти</button>
            </form>




        </div>
        <div th:replace="~{fragments/menuMobile :: menuMobile}"></div>
    </main>
    <div th:replace="~{fragments/menu :: menu}"></div>
</div>
<script>
    $(document).ready(function () {
        const searchInput = document.getElementById('searchInput');

        searchInput.addEventListener('input', function () {
            const searchTerm = searchInput.value;
            if(searchTerm.length > 2) {
            // Викликати функцію для виконання пошуку на сервері зі значенням searchTerm
            searchItems(searchTerm);
            }
        });

        function searchItems(searchTerm) {
            console.log(searchTerm + ' term');
            $.ajax({
                url: '/admin-page/search', // Шлях до вашого ендпоінта пошуку на сервері
                type: 'GET',
                data: { searchTerm: searchTerm },
                success: function(response) {
                    // Обробити отримані результати пошуку
                    displaySearchResults(response);
                    console.log(response + ' response');
                },
                error: function() {
                    console.error('Помилка при виконанні запиту на сервер');
                }
            });
        }

    function displaySearchResults(results) {
        const searchResultsContainer = document.getElementById('searchResults');
        searchResultsContainer.classList.add('search_result_style');
        if (results.length === 0) {
            console.log(results.length + ' length');
            searchResultsContainer.classList.remove('search_result_style');
        }
        // Додайте обробник події click на сторінці
        document.addEventListener('click', function(event) {
            const targetElement = event.target;

            // Перевірка, чи клікнули поза блоком результатів пошуку
            if (!searchResultsContainer.contains(targetElement)) {
                searchResultsContainer.innerHTML = '';
                searchResultsContainer.classList.remove('search_result_style');
            }
        });
        searchResultsContainer.innerHTML = '';

        for (let i = 0; i < results.length; i++) {
            const result = results[i];

            // Створення блоку для кожного результату
            const resultBlock = document.createElement('div');
            resultBlock.classList.add('result-block');

            // Створення назви
            const nameElement = document.createElement('h2');
            nameElement.textContent = result.engText;
            resultBlock.appendChild(nameElement);

            // Створення перекладу
            const translationElement = document.createElement('p');
            translationElement.textContent = result.ukrText;
            resultBlock.appendChild(translationElement);

            // Створення скритого поля з id екземпляра
            const idElement = document.createElement('input');
            idElement.type = 'hidden';
            idElement.value = result.id;
            resultBlock.appendChild(idElement);

            // Створення кнопки "Додати"
            const addButton = document.createElement('button');
            addButton.classList.add('add-button');
            addButton.textContent = 'Додати';
            addButton.addEventListener('click', function () {
                const selectedId = this.parentNode.querySelector('input[type="hidden"]').value;

                const addedItemsContainer = document.getElementById('addedItemsContainer');
                const newItem = document.createElement('div');
                newItem.classList.add('phrasesList');

                // Створення input з атрибутом name="id" та значенням value="${selectedId}"
                const inputElement = document.createElement('input');
                inputElement.type = 'hidden';
                inputElement.name = 'id';
                inputElement.value = selectedId;
                newItem.appendChild(inputElement);

                // Створення label для поля engText
                const labelElement = document.createElement('label');
                labelElement.textContent = result.engText;
                newItem.appendChild(labelElement);

                addedItemsContainer.appendChild(newItem);
            });

            resultBlock.appendChild(addButton);

            searchResultsContainer.appendChild(resultBlock);
        }
    }
    });




    $(document).ready(function () {
        tinymce.init({
            selector: 'textarea#phrasesPageInfo',
            height: 500,
            plugins: [
                'advlist', 'autolink', 'lists', 'link', 'image', 'charmap', 'preview',
                'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
                'insertdatetime', 'media', 'table', 'help', 'wordcount'
            ],
            toolbar:
                'undo redo | formatselect |' +
                ' bold italic underline forecolor | link image media table mergetags |' +
                ' addcomment showcomments | spellcheckdialog code typography |' +
                ' align lineheight | checklist numlist bullist indent outdent |' +
                ' emoticons charmap | removeformat'
            ,
            content_css: [
                '//fonts.googleapis.com/css?family=Lato:300,300i,400,400i',
                '//www.tiny.cloud/css/codepen.min.css'
            ],
            api_key: 'j8dxs8puyiugoamq11vn3bctaonh1jhzvd0cewcb1jiyl2c6',
            menubar: true,
            statusbar: true,
            branding: true
        });





        $('#phrasesPage').submit(function (event) {
            event.preventDefault();
            var csrfToken = $("meta[name='_csrf']").attr("content");
            var csrfHeader = $("meta[name='_csrf_header']").attr("content");
            const selectedItemsInput = document.querySelectorAll('#addedItemsContainer input[name="id"]');
            var translationPairList = [];
            selectedItemsInput.forEach(function(input) {
                translationPairList.push({ id: input.value });
            });
            var url = '/admin-page/page-phrases-save';
            var translationPairsPage = {
                id: $('#word input[name="id"]').val(),
                name: $('#word input[name="name"]').val(),
                published: $('#toggleSwitch').is(':checked'),
                info: $('#phrasesPage textarea[name="info"]').val(),
                translationPairList: translationPairList

            };
            var mainCategorySelect = {
                id: $('#mainCategorySelect').val()
            };
            var subcategorySelect = {
                id: $('#subcategorySelect').val()
            };
            var subSubcategorySelect = {
                id: $('#subSubcategorySelect').val()
            };
            var data = {
                translationPairsPage: translationPairsPage,
                mainCategorySelect: mainCategorySelect,
                subcategorySelect: subcategorySelect,
                subSubcategorySelect: subSubcategorySelect
            };
            $.ajax({
                // url: $(this).attr('action'),
                url: url,
                type: 'POST',
                contentType: "application/json",
                data: JSON.stringify(data),
                beforeSend: function (xhr) {
                    xhr.setRequestHeader(csrfHeader, csrfToken);
                },
                success: function (result) {
                    var status = result.status;
                    if (status == "Success") {
                        showSuccessToast(result.message);
                    } else {
                        showErrorToast(result.message);
                    }
                },
                error: function () {
                    let shel = {};
                    alert(Boolean(shel));
                    showErrorToast('Помилка запиту на сервер');
                }
            });
        });
    // });



    // $(document).ready(function () {
        const mainCategorySelect = document.getElementById('mainCategorySelect');
        const subcategorySelect = document.getElementById('subcategorySelect');
        const subSubcategorySelect = document.getElementById('subSubcategorySelect');
        mainCategorySelect.addEventListener('change', function () {
            const selectedCategoryId = mainCategorySelect.value;
            fetch(`/admin-page/getSubcategories?mainCategoryId=${selectedCategoryId}`)
                .then(response => response.json())
                .then(subcategories => {
                    if (subcategories.length > 0) {
                        subcategories.forEach(subcategory => {
                            const option = document.createElement('option');
                            option.value = subcategory.id;
                            option.text = subcategory.name;
                            subcategorySelect.appendChild(option);
                        });

                        // Показуємо subcategorySelect, якщо є підкатегорії
                        // subcategorySelect.style.display = subcategories.length > 0 ? 'block' : 'none';
                    } else {
                    }
                })
                .catch(error => {
                    console.error('Помилка при отриманні підкатегорій:', error);
                });
        // });
        subcategorySelect.addEventListener('change', function () {
            const selectedCategoryId = subcategorySelect.value;
            fetch(`/admin-page/getSubcategories?mainCategoryId=${selectedCategoryId}`)
                .then(response => response.json())
                .then(subcategories => {
                    if (subcategories.length > 0) {
                        subcategories.forEach(subcategory => {
                            const option = document.createElement('option');
                            option.value = subcategory.id;
                            option.text = subcategory.name;
                            subSubcategorySelect.appendChild(option);
                        });
                    } else {
                    }
                })
                .catch(error => {
                    console.error('Помилка при отриманні підкатегорій:', error);
                });
        });
    });
    });

</script>
</body>
</html>